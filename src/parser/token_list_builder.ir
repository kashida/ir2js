::TokenListBuilder
  @parsed\%.TokenList|A|O|s\$
  @tokens\%.TokenList\ new %.TokenList()

:build\%.TokenList\
  @build_rec(@parsed)
  => @tokens

:result\%.Result\
  input\!A.<InputLine>\$
  @.build()
  => new %.Result(@tokens, input)

:@build_rec
  data\%.TokenList|A|O|s\$
  if (data instanceof %.TokenList)
    @add_tokens(data)
    =>

  if (data instanceof Array)
    @add_array(data)
    =>

  if (data instanceof Object)
    @add_object(data)
    =>

  // Must be a string.
  if (data)
    @tokens.add(data)

:@add_tokens
  data\%.TokenList\$
  if (data instanceof %.ParamLine)
    t := @tokens
    @tokens = new %.ParamLine(#)
      data.name
      data.is_member
      data.access
      data.type
      data.marker
      new %.TokenListBuilder(data.init).build()
    @tokens.add(t)
  else if (data instanceof %.SeparatorLine)
    t := @tokens
    @tokens = new %.SeparatorLine()
    t.add(t)
    t.add(data)
  else
    @tokens.add(data)

:@add_array
  data\A\$
  data.forEach(##)
    elem\%.TokenList|A|O|s\$
    @build_rec(elem)

:@add_object
  data\O\$
  if (data.t)
    @tokens.add(new %.TokenListBuilder(data.t).build())
  if (data.p)
    @tokens.prepend(new %.TokenListBuilder(data.p).build())
